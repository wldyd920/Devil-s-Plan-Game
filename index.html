<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>수식 피라미드 게임</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f0f0f5;
      color: #333;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      padding: 20px 0;
      background-color: #37474f;
      color: #fff;
      margin-bottom: 0;
    }
    .game-container {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      padding: 20px;
    }
    .history {
      width: 180px;
      text-align: left;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }
    .history h3 {
      color: #37474f;
    }
    .history ul {
      list-style: none;
      padding-left: 0;
    }
    .main-game {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .target-box {
      align-self: flex-end;
      background: #ffecb3;
      color: #333;
      font-size: 22px;
      font-weight: bold;
      padding: 10px 20px;
      border-radius: 8px;
      border: 2px solid #ffc107;
      margin-bottom: 10px;
    }
    .pyramid {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 30px 0;
    }
    .row {
      display: flex;
      justify-content: center;
      margin: -55px 0;
    }
    .cell {
      width: 86.6px;
      height: 100px;
      background: #fff3e0;
      border: none;
      margin: 35px;
      position: relative;
      clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
      filter: drop-shadow(0 0 0 transparent);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-weight: bold;
    }
    .label {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 20px;
      background: #ffa726;
      color: #ffffff;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .value {
      font-size: 28px;
      font-weight: bold;
      color: #ff5722;
      font-family: Georgia, Serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      margin-top: 10px;
    }
    .selected {
      background: #ffe082;
      border-color: #ffa000;
    }
    #result {
      font-size: 18px;
      margin: 10px;
      color: #d84315;
    }
    .reset-button {
      margin-top: 10px;
      padding: 8px 16px;
      background: #4caf50;
      color: white;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .reset-button:hover {
      background: #388e3c;
    }
    .restart-button {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 6px 12px;
      font-size: 13px;
      background: #607d8b;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .restart-button:hover {
      background: #455a64;
    }
  </style>
</head>
<body>
  <h1>수식 피라미드 게임</h1>
  <div class="game-container">
    <div class="history">
      $1
<p id="answer-count">총 해답 수: 0</p>
<p id="total-solutions">가능한 정답 수: 계산 중...</p>
      <ul id="history-list"></ul>
    </div>
    <div class="main-game">
      <div class="target-box" id="target">🎯 TARGET: 12</div>
      <div class="pyramid" id="pyramid"></div>
      <div id="result"></div>
      <button class="reset-button" onclick="resetSelection()">선택 리셋</button>
    </div>
  </div>
  <button class="restart-button" onclick="restartGame()">게임 리스타트</button>
  <script>
    let cellsData = [];
    let selected = [];
    let history = new Set();
    let targetNumber = 12;

    const operators = ['+', '-', '*', '/'];

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateCells() {
      const letters = 'ABCDEFGHIJ'.split('');
      let list = [];
      let seenPairs = new Set();
      while (list.length < 10) {
        let val = getRandomInt(1, 20);
        let op = operators[Math.floor(Math.random() * operators.length)];
        let key = `${op}${val}`;
        if (seenPairs.has(key)) continue;
        seenPairs.add(key);
        list.push({
          letter: letters[list.length],
          val: val,
          op: op
        });
      }
      return list;
    }

    function buildPyramid() {
      const pyramid = document.getElementById('pyramid');
      pyramid.innerHTML = '';
      let index = 0;
      for (let row = 1; row <= 4; row++) {
        const rowEl = document.createElement('div');
        rowEl.className = 'row';
        for (let i = 0; i < row; i++) {
          const cell = cellsData[index];
          const cellEl = document.createElement('div');
          cellEl.className = 'cell';
          cellEl.dataset.index = index;

          const labelEl = document.createElement('div');
          labelEl.className = 'label';
          labelEl.innerText = cell.letter;

          const valueEl = document.createElement('div');
          valueEl.className = 'value';
          const symbol = cell.op === '*' ? '×' : cell.op === '/' ? '÷' : cell.op;
          valueEl.innerText = `${symbol}${cell.val}`;

          cellEl.appendChild(labelEl);
          cellEl.appendChild(valueEl);

          cellEl.addEventListener('click', () => selectCell(cellEl));
          rowEl.appendChild(cellEl);
          index++;
        }
        pyramid.appendChild(rowEl);
      }
    }

    function selectCell(cellEl) {
      if (cellEl.classList.contains('selected')) {
        cellEl.classList.remove('selected');
        selected = selected.filter(c => c !== cellEl);
      } else {
        if (selected.length < 3) {
          cellEl.classList.add('selected');
          selected.push(cellEl);
        }
      }
      if (selected.length === 3) calculateResult();
    }

    function calculateResult() {
      const indices = selected.map(c => parseInt(c.dataset.index));
      const values = indices.map(i => cellsData[i]);
      const key = selected.map(el => el.querySelector('.label').innerText).join('');
      if (history.has(key)) {
        document.getElementById('result').innerText = '❌ 이미 시도한 조합입니다 (-1점)';
        selected.forEach(c => c.classList.remove('selected'));
        selected = [];
        return;
      }

      let num = values[0].val;
      let result = eval(`${num} ${values[1].op} ${values[1].val}`);
      result = eval(`${result} ${values[2].op} ${values[2].val}`);

      if (Math.round(result) === targetNumber) {
        document.getElementById('result').innerText = '✅ 정답입니다! (+1점)';
        document.getElementById('history-list').innerHTML += `<li>${key}</li>`;
        history.add(key);
        document.getElementById('answer-count').innerText = `총 해답 수: ${history.size}`;
      } else {
        document.getElementById('result').innerText = '❌ 오답입니다 (-1점)';
      }

      selected.forEach(c => c.classList.remove('selected'));
      selected = [];
    }

    function resetSelection() {
      selected.forEach(c => c.classList.remove('selected'));
      selected = [];
    }

    function restartGame() {
      function countValidSolutions() {
        let count = 0;
        for (let i = 0; i < 10; i++) {
          for (let j = 0; j < 10; j++) {
            for (let k = 0; k < 10; k++) {
              if (i === j || j === k || i === k) continue;
              let a = cellsData[i];
              let b = cellsData[j];
              let c = cellsData[k];
              let temp1 = eval(`${a.val} ${b.op} ${b.val}`);
              let temp2 = eval(`${temp1} ${c.op} ${c.val}`);
              if (Math.round(temp2) === targetNumber) {
                count++;
              }
            }
          }
        }
        return count;
      }

      let validCount = 0;
      do {
        cellsData = generateCells();
        targetNumber = getRandomInt(-20, 20);
        validCount = 0;
        for (let i = 0; i < 10; i++) {
          for (let j = 0; j < 10; j++) {
            for (let k = 0; k < 10; k++) {
              if (i === j || j === k || i === k) continue;
              let a = cellsData[i];
              let b = cellsData[j];
              let c = cellsData[k];
              let temp1 = eval(`${a.val} ${b.op} ${b.val}`);
              let temp2 = eval(`${temp1} ${c.op} ${c.val}`);
              if (Math.round(temp2) === targetNumber) {
                validCount++;
              }
            }
          }
        }
      } while (validCount === 0);
      selected = [];
      history = new Set();
      document.getElementById('history-list').innerHTML = '';
      targetNumber = getRandomInt(-20, 20);
      document.getElementById('target').innerText = `🎯 TARGET: ${targetNumber}`;
      buildPyramid();
      document.getElementById('result').innerText = '';
      document.getElementById('answer-count').innerText = '총 해답 수: 0';
      document.getElementById('total-solutions').innerText = `가능한 정답 수: ${validCount}`;
      countValidSolutions();
    }

    restartGame();
  </script>
</body>
</html>
